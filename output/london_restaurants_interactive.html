
<!DOCTYPE html>
<html>
<head>
    <title>London Restaurant Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Fonts: Inter for a clean, professional look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: #333; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* --- Professional Sidebar --- */
        #sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            bottom: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        
        /* Mobile toggle */
        #sidebar-toggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* Fullscreen Button */
        #fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 60px;
            z-index: 1001;
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: #333;
            transition: background 0.2s;
        }
        #fullscreen-btn:hover { background: #f5f5f5; }

        /* Help Button */
        #help-btn {
            position: absolute;
            top: 20px;
            right: 170px;
            z-index: 1001;
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: #333;
            transition: background 0.2s;
        }
        #help-btn:hover { background: #f5f5f5; }

        /* Modal Styling */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            position: relative;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .tutorial-step {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 22px; font-weight: 600; color: #1a1a1a; letter-spacing: -0.5px; }
        h2 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: #888; font-weight: 600; }
        
        .control-section { border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .control-section:last-child { border-bottom: none; }

        /* Inputs */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { outline: none; border-color: #333; }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .toggle-label { font-size: 14px; font-weight: 500; color: #333; }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 20px;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input[type="checkbox"] { display: none; }
        input[type="checkbox"]:checked + .toggle-switch { background: #2a9d8f; }
        input[type="checkbox"]:checked + .toggle-switch::after { transform: translateX(20px); }

        /* Custom Range Slider */
        .range-container { margin-top: 10px; }
        .range-header { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; font-weight: 500; }
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #1a1a1a;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e0e0e0;
            border-radius: 2px;
        }

        /* Price Filter Buttons */
        .price-buttons { display: flex; gap: 8px; }
        .price-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
        }
        .price-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        /* Stats & Legend */
        .stats { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 13px; 
            color: #555;
            text-align: center;
        }
        .stats strong { color: #1a1a1a; font-size: 16px; display: block; margin-bottom: 4px; }

        .legend { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 150px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; font-size: 12px; color: #555; cursor: pointer; padding: 2px; border-radius: 4px; }
        .legend-item:hover { background: #f0f0f0; }
        .color-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }

        /* Popup Styling */
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 0; }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .popup-header { background: #1a1a1a; color: white; padding: 12px 15px; border-radius: 8px 8px 0 0; }
        .popup-title { font-weight: 600; font-size: 15px; margin: 0; }
        .popup-body { padding: 15px; font-size: 13px; line-height: 1.5; }
        .popup-meta { display: flex; justify-content: space-between; margin-bottom: 8px; color: #666; }
        .popup-rating { font-weight: 600; color: #1a1a1a; display: flex; align-items: center; gap: 4px; }
        .star-icon { color: #f59e0b; }
        .popup-link { 
            display: block; 
            margin-top: 12px; 
            text-align: center; 
            background: #f0f0f0; 
            color: #333; 
            text-decoration: none; 
            padding: 8px; 
            border-radius: 6px; 
            font-weight: 500;
            transition: background 0.2s;
        }
        .popup-link:hover { background: #e0e0e0; }
        
        .underrated-badge {
            background: #2a9d8f;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            #sidebar { transform: translateX(-110%); width: 85%; left: 0; top: 0; bottom: 0; border-radius: 0; }
            #sidebar.open { transform: translateX(0); }
            #sidebar-toggle { display: block; }
            #fullscreen-btn { display: none; } /* Hide fullscreen on mobile as it's less useful/buggy */
        }
    </style>
</head>
<body>

<button id="sidebar-toggle" onclick="toggleSidebar()">‚ò∞ Filters</button>
<button id="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
<button id="help-btn" onclick="toggleHelp()">? Help</button>

<div id="helpModal" class="modal-overlay" onclick="if(event.target === this) toggleHelp()">
    <div class="modal-content">
        <button class="close-modal" onclick="toggleHelp()">√ó</button>
        <h2 style="font-size: 20px; color: #1a1a1a; margin-bottom: 20px;">How to use this map</h2>
        
        <div class="tutorial-step">
            <div class="step-icon">üíé</div>
            <div>
                <strong>Find Underrated Gems</strong>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">Toggle "Highlight Underrated Gems" to see spots where our machine learning model thinks the rating should be higher than it is.</p>
            </div>
        </div>

        <div class="tutorial-step">
            <div class="step-icon">üîç</div>
            <div>
                <strong>Filter & Search</strong>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">Use the sidebar to filter by borough, cuisine, price, rating, or search for a specific restaurant name.</p>
            </div>
        </div>

        <div class="tutorial-step">
            <div class="step-icon">üé®</div>
            <div>
                <strong>Explore Cuisines</strong>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">Click items in the "Cuisines Legend" to instantly filter the map to that specific cuisine type.</p>
            </div>
        </div>
        
        <button onclick="toggleHelp()" style="width: 100%; padding: 12px; background: #1a1a1a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;">Got it!</button>
    </div>
</div>

<div id="sidebar">
    <div class="control-section">
        <h1>London Food Map</h1>
        <div style="font-size: 11px; color: #999; margin-top: 4px;">
            Built by <a href="https://laurenleek.eu" target="_blank" style="color: #666; text-decoration: none; font-weight: 500;">Lauren Leek</a>
        </div>
    </div>

    <div class="control-section">
        <input type="text" id="searchInput" placeholder="Search by name..." oninput="updateMap()">
    </div>

    <div class="control-section">
        <h2>Filters</h2>
        
        <label class="toggle-container">
            <span class="toggle-label">Highlight Underrated Gems</span>
            <input type="checkbox" id="underratedToggle" onchange="updateMap()">
            <div class="toggle-switch"></div>
        </label>

        <label class="toggle-container">
            <span class="toggle-label">Only Independents</span>
            <input type="checkbox" id="independentToggle" onchange="updateMap()">
            <div class="toggle-switch"></div>
        </label>
        
        <div style="margin-bottom: 15px;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px;">Borough</label>
            <select id="boroughSelect" onchange="onBoroughChange()">
                <option value="All">All Boroughs</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px;">Cuisine</label>
            <select id="cuisineSelect" onchange="updateMap()">
                <option value="All">All Cuisines</option>
            </select>
        </div>

        <div class="range-container">
            <div class="range-header">
                <span>Min Rating</span>
                <span id="ratingVal">0.0</span>
            </div>
            <input type="range" id="ratingRange" min="0" max="5" step="0.1" value="0" oninput="updateMap()">
        </div>

        <div class="range-container">
            <div class="range-header">
                <span>Min Reviews</span>
                <span id="reviewVal">0</span>
            </div>
            <input type="range" id="reviewRange" min="0" max="500" step="10" value="0" oninput="updateMap()">
        </div>
    </div>

    <div class="control-section">
        <h2>Price Level</h2>
        <div class="price-buttons" id="priceFilters">
            <div class="price-btn active" onclick="togglePrice(1, this)">¬£</div>
            <div class="price-btn active" onclick="togglePrice(2, this)">¬£¬£</div>
            <div class="price-btn active" onclick="togglePrice(3, this)">¬£¬£¬£</div>
            <div class="price-btn active" onclick="togglePrice(4, this)">¬£¬£¬£¬£</div>
        </div>
    </div>

    <div class="control-section">
        <h2>Cuisines Legend</h2>
        <div id="legend" class="legend"></div>
    </div>

    <div class="stats" id="stats">
        <strong>0</strong> restaurants visible
    </div>
</div>

<div id="map"></div>

<script>
    // --- Data ---
    var restaurants = [{"lat": 51.51675, "lon": -0.10693, "name": "The Greek Spot 0", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 4.9, "reviews": 1374, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.44, "borough": "City of London", "is_chain": 0}, {"lat": 51.51374, "lon": -0.10279, "name": "The Italian Spot 2", "cuisine": "Italian", "cuisine_group": "Italian", "rating": 4.2, "reviews": 1300, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.24, "borough": "City of London", "is_chain": 0}, {"lat": 51.51209, "lon": -0.0831, "name": "The Lebanese Spot 4", "cuisine": "Middle Eastern", "cuisine_group": "Middle Eastern", "rating": 4.4, "reviews": 721, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.12, "borough": "City of London", "is_chain": 0}, {"lat": 51.50847, "lon": -0.08229, "name": "The Spanish Spot 6", "cuisine": "Spanish", "cuisine_group": "Spanish", "rating": 4.0, "reviews": 585, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.19, "borough": "City of London", "is_chain": 0}, {"lat": 51.51311, "lon": -0.10888, "name": "The Peruvian Spot 10", "cuisine": "Peruvian", "cuisine_group": "Peruvian", "rating": 3.7, "reviews": 1194, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.61, "borough": "City of London", "is_chain": 0}, {"lat": 51.50954, "lon": -0.09526, "name": "The Polish Spot 12", "cuisine": "Polish", "cuisine_group": "Polish", "rating": 4.2, "reviews": 1112, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.39, "borough": "City of London", "is_chain": 0}, {"lat": 51.51435, "lon": -0.07419, "name": "The Brazilian Spot 13", "cuisine": "Brazilian", "cuisine_group": "Brazilian", "rating": 5.0, "reviews": 1080, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.18, "borough": "City of London", "is_chain": 0}, {"lat": 51.51048, "lon": -0.08835, "name": "The Korean Spot 14", "cuisine": "Korean", "cuisine_group": "Korean", "rating": 3.5, "reviews": 1788, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.74, "borough": "City of London", "is_chain": 0}, {"lat": 51.51169, "lon": -0.07933, "name": "The Mexican Spot 16", "cuisine": "Mexican", "cuisine_group": "Mexican", "rating": 4.4, "reviews": 863, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.12, "borough": "City of London", "is_chain": 0}, {"lat": 51.51502, "lon": -0.08989, "name": "The Peruvian Spot 17", "cuisine": "Peruvian", "cuisine_group": "Peruvian", "rating": 4.4, "reviews": 1452, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.22, "borough": "City of London", "is_chain": 0}, {"lat": 51.51825, "lon": -0.07828, "name": "The Brazilian Spot 18", "cuisine": "Brazilian", "cuisine_group": "Brazilian", "rating": 4.1, "reviews": 1669, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.50895, "lon": -0.08331, "name": "The Lebanese Spot 21", "cuisine": "Middle Eastern", "cuisine_group": "Middle Eastern", "rating": 4.6, "reviews": 734, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.0, "borough": "City of London", "is_chain": 0}, {"lat": 51.51208, "lon": -0.09723, "name": "The Mexican Spot 22", "cuisine": "Mexican", "cuisine_group": "Mexican", "rating": 4.5, "reviews": 1171, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.18, "borough": "City of London", "is_chain": 0}, {"lat": 51.5116, "lon": -0.08761, "name": "The Turkish Spot 25", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 4.7, "reviews": 503, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.09, "borough": "City of London", "is_chain": 0}, {"lat": 51.5142, "lon": -0.10215, "name": "The Italian Spot 26", "cuisine": "Italian", "cuisine_group": "Italian", "rating": 4.6, "reviews": 1299, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.16, "borough": "City of London", "is_chain": 0}, {"lat": 51.51152, "lon": -0.08241, "name": "The Polish Spot 28", "cuisine": "Polish", "cuisine_group": "Polish", "rating": 4.8, "reviews": 479, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.51053, "lon": -0.07395, "name": "The Malaysian Spot 30", "cuisine": "Malaysian", "cuisine_group": "Malaysian", "rating": 3.9, "reviews": 1703, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.34, "borough": "City of London", "is_chain": 0}, {"lat": 51.51859, "lon": -0.09597, "name": "The Lebanese Spot 32", "cuisine": "Middle Eastern", "cuisine_group": "Middle Eastern", "rating": 4.5, "reviews": 1913, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.12, "borough": "City of London", "is_chain": 0}, {"lat": 51.51475, "lon": -0.08726, "name": "The Greek Spot 33", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 3.7, "reviews": 570, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.55, "borough": "City of London", "is_chain": 0}, {"lat": 51.51706, "lon": -0.08976, "name": "The Mexican Spot 35", "cuisine": "Mexican", "cuisine_group": "Mexican", "rating": 4.7, "reviews": 1600, "price": 3, "vicinity": "City of London, London", "hype_residual": 0.4, "borough": "City of London", "is_chain": 0}, {"lat": 51.5119, "lon": -0.0914, "name": "The Caribbean Spot 37", "cuisine": "Caribbean", "cuisine_group": "Caribbean", "rating": 4.4, "reviews": 1894, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.1, "borough": "City of London", "is_chain": 0}, {"lat": 51.51098, "lon": -0.07603, "name": "The Japanese Spot 38", "cuisine": "Japanese", "cuisine_group": "Japanese", "rating": 4.3, "reviews": 376, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.49, "borough": "City of London", "is_chain": 0}, {"lat": 51.51286, "lon": -0.09329, "name": "The Brazilian Spot 40", "cuisine": "Brazilian", "cuisine_group": "Brazilian", "rating": 5.0, "reviews": 471, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.21, "borough": "City of London", "is_chain": 0}, {"lat": 51.51559, "lon": -0.09177, "name": "The Korean Spot 41", "cuisine": "Korean", "cuisine_group": "Korean", "rating": 4.2, "reviews": 1169, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.4, "borough": "City of London", "is_chain": 0}, {"lat": 51.51454, "lon": -0.08216, "name": "The Polish Spot 45", "cuisine": "Polish", "cuisine_group": "Polish", "rating": 4.4, "reviews": 811, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.12, "borough": "City of London", "is_chain": 0}, {"lat": 51.51514, "lon": -0.08178, "name": "The Polish Spot 47", "cuisine": "Polish", "cuisine_group": "Polish", "rating": 3.6, "reviews": 633, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.63, "borough": "City of London", "is_chain": 0}, {"lat": 51.50892, "lon": -0.08591, "name": "The Greek Spot 48", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 4.4, "reviews": 1921, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.22, "borough": "City of London", "is_chain": 0}, {"lat": 51.51666, "lon": -0.10736, "name": "The Korean Spot 50", "cuisine": "Korean", "cuisine_group": "Korean", "rating": 5.0, "reviews": 198, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.21, "borough": "City of London", "is_chain": 0}, {"lat": 51.51909, "lon": -0.08411, "name": "The Argentinian Spot 53", "cuisine": "Argentinian", "cuisine_group": "Argentinian", "rating": 4.4, "reviews": 1035, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.35, "borough": "City of London", "is_chain": 0}, {"lat": 51.51591, "lon": -0.10679, "name": "The Argentinian Spot 54", "cuisine": "Argentinian", "cuisine_group": "Argentinian", "rating": 3.6, "reviews": 1839, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.7, "borough": "City of London", "is_chain": 0}, {"lat": 51.51679, "lon": -0.10359, "name": "The Malaysian Spot 58", "cuisine": "Malaysian", "cuisine_group": "Malaysian", "rating": 4.8, "reviews": 419, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.50855, "lon": -0.08286, "name": "The Ethiopian Spot 60", "cuisine": "Ethiopian", "cuisine_group": "Ethiopian", "rating": 4.4, "reviews": 696, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.17, "borough": "City of London", "is_chain": 0}, {"lat": 51.51395, "lon": -0.08941, "name": "The Indian Spot 61", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 4.4, "reviews": 1227, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.13, "borough": "City of London", "is_chain": 0}, {"lat": 51.50874, "lon": -0.08563, "name": "The Indian Spot 62", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 4.9, "reviews": 589, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.35, "borough": "City of London", "is_chain": 0}, {"lat": 51.51617, "lon": -0.07871, "name": "The Turkish Spot 64", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 4.3, "reviews": 1868, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.06, "borough": "City of London", "is_chain": 0}, {"lat": 51.51605, "lon": -0.07637, "name": "The Indian Spot 65", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 4.2, "reviews": 249, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.47, "borough": "City of London", "is_chain": 0}, {"lat": 51.51662, "lon": -0.10701, "name": "The Turkish Spot 66", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 3.8, "reviews": 1293, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.47, "borough": "City of London", "is_chain": 0}, {"lat": 51.51473, "lon": -0.09059, "name": "The Malaysian Spot 67", "cuisine": "Malaysian", "cuisine_group": "Malaysian", "rating": 4.9, "reviews": 1027, "price": 3, "vicinity": "City of London, London", "hype_residual": 0.15, "borough": "City of London", "is_chain": 0}, {"lat": 51.51687, "lon": -0.10448, "name": "The Spanish Spot 71", "cuisine": "Spanish", "cuisine_group": "Spanish", "rating": 3.7, "reviews": 982, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.67, "borough": "City of London", "is_chain": 0}, {"lat": 51.50969, "lon": -0.08159, "name": "The Malaysian Spot 72", "cuisine": "Malaysian", "cuisine_group": "Malaysian", "rating": 3.7, "reviews": 715, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.87, "borough": "City of London", "is_chain": 0}, {"lat": 51.51561, "lon": -0.09549, "name": "The Greek Spot 73", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 4.4, "reviews": 1123, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.19, "borough": "City of London", "is_chain": 0}, {"lat": 51.51304, "lon": -0.08097, "name": "The Polish Spot 74", "cuisine": "Polish", "cuisine_group": "Polish", "rating": 4.7, "reviews": 1149, "price": 3, "vicinity": "City of London, London", "hype_residual": 0.08, "borough": "City of London", "is_chain": 0}, {"lat": 51.51298, "lon": -0.07984, "name": "The Japanese Spot 77", "cuisine": "Japanese", "cuisine_group": "Japanese", "rating": 4.9, "reviews": 624, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.14, "borough": "City of London", "is_chain": 0}, {"lat": 51.50881, "lon": -0.09255, "name": "The Korean Spot 78", "cuisine": "Korean", "cuisine_group": "Korean", "rating": 4.5, "reviews": 379, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.17, "borough": "City of London", "is_chain": 0}, {"lat": 51.51336, "lon": -0.09756, "name": "The Ethiopian Spot 85", "cuisine": "Ethiopian", "cuisine_group": "Ethiopian", "rating": 3.6, "reviews": 1979, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.64, "borough": "City of London", "is_chain": 0}, {"lat": 51.51508, "lon": -0.08346, "name": "The Argentinian Spot 90", "cuisine": "Argentinian", "cuisine_group": "Argentinian", "rating": 4.3, "reviews": 1441, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.32, "borough": "City of London", "is_chain": 0}, {"lat": 51.51159, "lon": -0.08406, "name": "The Turkish Spot 92", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 4.8, "reviews": 726, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.52092, "lon": -0.09277, "name": "The Spanish Spot 94", "cuisine": "Spanish", "cuisine_group": "Spanish", "rating": 4.9, "reviews": 427, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.23, "borough": "City of London", "is_chain": 0}, {"lat": 51.51055, "lon": -0.07858, "name": "The Italian Spot 95", "cuisine": "Italian", "cuisine_group": "Italian", "rating": 4.7, "reviews": 436, "price": 3, "vicinity": "City of London, London", "hype_residual": 0.07, "borough": "City of London", "is_chain": 0}, {"lat": 51.51409, "lon": -0.10105, "name": "The Lebanese Spot 97", "cuisine": "Middle Eastern", "cuisine_group": "Middle Eastern", "rating": 4.0, "reviews": 592, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.76, "borough": "City of London", "is_chain": 0}, {"lat": 51.51181, "lon": -0.08455, "name": "The Thai Spot 99", "cuisine": "Thai", "cuisine_group": "Thai", "rating": 4.1, "reviews": 1374, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.36, "borough": "City of London", "is_chain": 0}, {"lat": 51.5121, "lon": -0.10267, "name": "The Peruvian Spot 0", "cuisine": "Peruvian", "cuisine_group": "Peruvian", "rating": 4.9, "reviews": 1130, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.15, "borough": "City of London", "is_chain": 0}, {"lat": 51.51395, "lon": -0.10237, "name": "The Italian Spot 1", "cuisine": "Italian", "cuisine_group": "Italian", "rating": 4.9, "reviews": 597, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.26, "borough": "City of London", "is_chain": 0}, {"lat": 51.51095, "lon": -0.08666, "name": "The Spanish Spot 5", "cuisine": "Spanish", "cuisine_group": "Spanish", "rating": 4.7, "reviews": 1111, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.02, "borough": "City of London", "is_chain": 0}, {"lat": 51.51444, "lon": -0.0989, "name": "The Chinese Spot 6", "cuisine": "Chinese", "cuisine_group": "Chinese", "rating": 4.6, "reviews": 1405, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.36, "borough": "City of London", "is_chain": 0}, {"lat": 51.51081, "lon": -0.0972, "name": "The Argentinian Spot 7", "cuisine": "Argentinian", "cuisine_group": "Argentinian", "rating": 4.2, "reviews": 1795, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.04, "borough": "City of London", "is_chain": 0}, {"lat": 51.51098, "lon": -0.0863, "name": "The Peruvian Spot 9", "cuisine": "Peruvian", "cuisine_group": "Peruvian", "rating": 4.0, "reviews": 1182, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.27, "borough": "City of London", "is_chain": 0}, {"lat": 51.51593, "lon": -0.09114, "name": "The Peruvian Spot 10", "cuisine": "Peruvian", "cuisine_group": "Peruvian", "rating": 3.7, "reviews": 359, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.9, "borough": "City of London", "is_chain": 0}, {"lat": 51.51016, "lon": -0.0801, "name": "The Malaysian Spot 20", "cuisine": "Malaysian", "cuisine_group": "Malaysian", "rating": 4.6, "reviews": 567, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.19, "borough": "City of London", "is_chain": 0}, {"lat": 51.51607, "lon": -0.08496, "name": "The Greek Spot 21", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 4.5, "reviews": 1258, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.19, "borough": "City of London", "is_chain": 0}, {"lat": 51.50836, "lon": -0.08053, "name": "The Indian Spot 23", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 5.0, "reviews": 1567, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.38, "borough": "City of London", "is_chain": 0}, {"lat": 51.51431, "lon": -0.10917, "name": "The Japanese Spot 25", "cuisine": "Japanese", "cuisine_group": "Japanese", "rating": 3.7, "reviews": 689, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.53, "borough": "City of London", "is_chain": 0}, {"lat": 51.5117, "lon": -0.09529, "name": "The French Spot 27", "cuisine": "French", "cuisine_group": "French", "rating": 4.1, "reviews": 1519, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.51302, "lon": -0.1051, "name": "The Argentinian Spot 31", "cuisine": "Argentinian", "cuisine_group": "Argentinian", "rating": 4.5, "reviews": 1324, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.23, "borough": "City of London", "is_chain": 0}, {"lat": 51.51737, "lon": -0.08854, "name": "The Brazilian Spot 34", "cuisine": "Brazilian", "cuisine_group": "Brazilian", "rating": 4.2, "reviews": 124, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.47, "borough": "City of London", "is_chain": 0}, {"lat": 51.51942, "lon": -0.09943, "name": "The Mexican Spot 35", "cuisine": "Mexican", "cuisine_group": "Mexican", "rating": 4.2, "reviews": 823, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.08, "borough": "City of London", "is_chain": 0}, {"lat": 51.51336, "lon": -0.09808, "name": "The Turkish Spot 44", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 3.7, "reviews": 1438, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.54, "borough": "City of London", "is_chain": 0}, {"lat": 51.51215, "lon": -0.10129, "name": "The Caribbean Spot 50", "cuisine": "Caribbean", "cuisine_group": "Caribbean", "rating": 4.8, "reviews": 1394, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.07, "borough": "City of London", "is_chain": 0}, {"lat": 51.5147, "lon": -0.07976, "name": "The Korean Spot 52", "cuisine": "Korean", "cuisine_group": "Korean", "rating": 4.1, "reviews": 1823, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.2, "borough": "City of London", "is_chain": 0}, {"lat": 51.50996, "lon": -0.10508, "name": "The Indian Spot 53", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 3.7, "reviews": 137, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.97, "borough": "City of London", "is_chain": 0}, {"lat": 51.51681, "lon": -0.0933, "name": "The Greek Spot 56", "cuisine": "Greek", "cuisine_group": "Greek", "rating": 3.8, "reviews": 467, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.8, "borough": "City of London", "is_chain": 0}, {"lat": 51.51618, "lon": -0.10138, "name": "The Japanese Spot 66", "cuisine": "Japanese", "cuisine_group": "Japanese", "rating": 4.0, "reviews": 131, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.63, "borough": "City of London", "is_chain": 0}, {"lat": 51.51755, "lon": -0.09897, "name": "The Japanese Spot 69", "cuisine": "Japanese", "cuisine_group": "Japanese", "rating": 4.7, "reviews": 50, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.03, "borough": "City of London", "is_chain": 0}, {"lat": 51.51852, "lon": -0.08707, "name": "The Chinese Spot 73", "cuisine": "Chinese", "cuisine_group": "Chinese", "rating": 4.9, "reviews": 920, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.3, "borough": "City of London", "is_chain": 0}, {"lat": 51.51266, "lon": -0.103, "name": "The Italian Spot 74", "cuisine": "Italian", "cuisine_group": "Italian", "rating": 4.1, "reviews": 579, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.23, "borough": "City of London", "is_chain": 0}, {"lat": 51.5132, "lon": -0.10356, "name": "The Indian Spot 77", "cuisine": "Indian", "cuisine_group": "Indian", "rating": 4.7, "reviews": 1306, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.24, "borough": "City of London", "is_chain": 0}, {"lat": 51.51831, "lon": -0.08023, "name": "The Vietnamese Spot 78", "cuisine": "Unknown", "cuisine_group": "Unknown", "rating": 3.5, "reviews": 1275, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.77, "borough": "City of London", "is_chain": 0}, {"lat": 51.51707, "lon": -0.08196, "name": "The Lebanese Spot 79", "cuisine": "Middle Eastern", "cuisine_group": "Middle Eastern", "rating": 5.0, "reviews": 139, "price": 1, "vicinity": "City of London, London", "hype_residual": 0.33, "borough": "City of London", "is_chain": 0}, {"lat": 51.51389, "lon": -0.08737, "name": "The French Spot 81", "cuisine": "French", "cuisine_group": "French", "rating": 4.7, "reviews": 1979, "price": 2, "vicinity": "City of London, London", "hype_residual": 0.4, "borough": "City of London", "is_chain": 0}, {"lat": 51.51351, "lon": -0.07611, "name": "The Spanish Spot 87", "cuisine": "Spanish", "cuisine_group": "Spanish", "rating": 4.3, "reviews": 1440, "price": 4, "vicinity": "City of London, London", "hype_residual": 0.06, "borough": "City of London", "is_chain": 0}, {"lat": 51.5123, "lon": -0.08536, "name": "The Ethiopian Spot 88", "cuisine": "Ethiopian", "cuisine_group": "Ethiopian", "rating": 3.7, "reviews": 1014, "price": 1, "vicinity": "City of London, London", "hype_residual": -0.67, "borough": "City of London", "is_chain": 0}, {"lat": 51.51696, "lon": -0.10153, "name": "The Turkish Spot 91", "cuisine": "Turkish", "cuisine_group": "Turkish", "rating": 4.3, "reviews": 111, "price": 4, "vicinity": "City of London, London", "hype_residual": -0.49, "borough": "City of London", "is_chain": 0}, {"lat": 51.51375, "lon": -0.09446, "name": "The Vietnamese Spot 92", "cuisine": "Unknown", "cuisine_group": "Unknown", "rating": 4.5, "reviews": 471, "price": 3, "vicinity": "City of London, London", "hype_residual": -0.13, "borough": "City of London", "is_chain": 0}, {"lat": 51.51228, "lon": -0.09254, "name": "The French Spot 96", "cuisine": "French", "cuisine_group": "French", "rating": 3.5, "reviews": 898, "price": 2, "vicinity": "City of London, London", "hype_residual": -0.78, "borough": "City of London", "is_chain": 0}];
    var boroughCenters = {"Barking and Dagenham": [51.5439733098687, 0.13326625941403827], "Barnet": [51.61606062116871, -0.20997980373590427], "Bexley": [51.4608957463956, 0.14244159863224562], "Brent": [51.55858163287106, -0.26780460681751533], "Bromley": [51.37200988935188, 0.05158668232074301], "Camden": [51.54642055108857, -0.15738444137965088], "City of London": [51.51440005478923, -0.0923727851727351], "Croydon": [51.35533905014297, -0.08712118343429286], "Ealing": [51.522496795532746, -0.33101497211752956], "Enfield": [51.65103056181731, -0.08722903822830082], "Greenwich": [51.47442323124656, 0.05563592406577554], "Hackney": [51.55229622349864, -0.06328089512094315], "Hammersmith and Fulham": [51.49503769776083, -0.22076636427501067], "Haringey": [51.59039906291803, -0.10744016630081368], "Harrow": [51.597755894133705, -0.3412456816565335], "Havering": [51.56315055154455, 0.22050170128200705], "Hillingdon": [51.541543007542806, -0.4456509600037819], "Hounslow": [51.468514417331164, -0.366126848413246], "Islington": [51.54849166977621, -0.11020273055563574], "Kensington and Chelsea": [51.501239854849956, -0.19219189466867562], "Kingston upon Thames": [51.387912795728425, -0.2868831806628104], "Lambeth": [51.45383513644726, -0.11827970449008177], "Lewisham": [51.44829889698769, -0.020255880846015924], "Merton": [51.409958119875455, -0.19723382656438893], "Newham": [51.5268707181886, 0.03760858878341776], "Redbridge": [51.58567862479543, 0.07592065488055044], "Richmond upon Thames": [51.44276371280896, -0.3123274200084182], "Southwark": [51.474245731999055, -0.07400514049631074], "Sutton": [51.362087920615686, -0.17755104347434209], "Tower Hamlets": [51.515752220586734, -0.03459973528554578], "Waltham Forest": [51.59406950439167, -0.012587492222957238], "Wandsworth": [51.451991417981155, -0.18617450567092778], "Westminster": [51.51346024866107, -0.1604051376571099]};
    var allBoroughs = ["Barking and Dagenham", "Barnet", "Bexley", "Brent", "Bromley", "Camden", "City of London", "Croydon", "Ealing", "Enfield", "Greenwich", "Hackney", "Hammersmith and Fulham", "Haringey", "Harrow", "Havering", "Hillingdon", "Hounslow", "Islington", "Kensington and Chelsea", "Kingston upon Thames", "Lambeth", "Lewisham", "Merton", "Newham", "Redbridge", "Richmond upon Thames", "Southwark", "Sutton", "Tower Hamlets", "Waltham Forest", "Wandsworth", "Westminster"];
    var dataBounds = [[51.50836284604529, -0.1091694828121976], [51.52091539069321, -0.0739509912168971]];
    
    // --- State ---
    var activePrices = [1, 2, 3, 4];
    
    // --- Map Init ---
    var map = L.map('map', {preferCanvas: true, zoomControl: false}).setView([51.5074, -0.1278], 12);
    
    // Move zoom control to top right
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // Ensure the initial view includes all points (important when data contains areas outside central London)
    try {
        map.fitBounds(dataBounds, { padding: [30, 30] });
    } catch (e) {
        // Fallback to default London view if bounds are invalid
    }

    var markersLayer = L.layerGroup().addTo(map);

    // --- Colors ---
    // A more professional, muted palette
    var colors = [
        "#e63946", "#2a9d8f", "#e9c46a", "#f4a261", "#264653", 
        "#8d99ae", "#ef476f", "#06d6a0", "#118ab2", "#073b4c",
        "#9b5de5", "#f15bb5", "#fee440", "#00bbf9", "#00f5d4",
        "#606c38", "#283618", "#dda15e", "#bc6c25", "#333333"
    ];
    
    // Fixed colors for key cuisines to ensure consistency
    var fixedColors = {
        "Pub": "#d62828",       // Red
        "British": "#003049",   // Dark Blue
        "Italian": "#2a9d8f",   // Teal
        "Indian": "#e9c46a",    // Yellow
        "Chinese": "#f4a261",   // Orange
        "Japanese": "#9b5de5",  // Purple
        "French": "#00bbf9",    // Light Blue
        "American": "#333333",  // Dark Grey
        "Cafe": "#bc6c25",      // Brown
        "Coffee": "#bc6c25",    // Brown
        "Pizza": "#e76f51",     // Burnt Orange
        "Burger": "#8d99ae",    // Grey Blue
        "Thai": "#06d6a0",      // Green
        "Turkish": "#ef476f",   // Pink
        "Middle Eastern": "#dda15e" // Tan
    };
    
    var cuisineColors = {};
    var uniqueCuisines = [...new Set(restaurants.map(r => r.cuisine_group))].sort();
    // Populate borough dropdown from the GeoJSON list (all boroughs),
    // but fall back to restaurant-derived boroughs if GeoJSON load failed.
    var uniqueBoroughs = (allBoroughs && allBoroughs.length)
        ? [...allBoroughs]
        : [...new Set(restaurants.map(r => r.borough))].sort();

    // Pin key cuisines to the top so they're always visible in the dropdown/legend
    var cuisinePriority = { "Pub": 0, "British": 1 };
    uniqueCuisines.sort((a, b) => {
        var pa = (a in cuisinePriority) ? cuisinePriority[a] : 999;
        var pb = (b in cuisinePriority) ? cuisinePriority[b] : 999;
        if (pa !== pb) return pa - pb;
        return a.localeCompare(b);
    });
    
    if (uniqueCuisines.includes("Other")) {
        uniqueCuisines = uniqueCuisines.filter(c => c !== "Other");
        uniqueCuisines.push("Other");
    }
    
    uniqueCuisines.forEach((c, i) => {
        if (fixedColors[c]) {
            cuisineColors[c] = fixedColors[c];
        } else {
            cuisineColors[c] = colors[i % colors.length];
        }
    });

    // --- Populate UI ---
    var select = document.getElementById('cuisineSelect');
    uniqueCuisines.forEach(c => {
        var opt = document.createElement('option');
        opt.value = c;
        opt.innerHTML = c;
        select.appendChild(opt);
    });

    var boroughSelect = document.getElementById('boroughSelect');
    uniqueBoroughs.forEach(b => {
        if (b === "Unknown") return;
        var opt = document.createElement('option');
        opt.value = b;
        opt.innerHTML = b;
        boroughSelect.appendChild(opt);
    });

    var legend = document.getElementById('legend');
    uniqueCuisines.forEach(c => {
        var item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="color-dot" style="background:${cuisineColors[c]}"></div>${c}`;
        item.onclick = () => {
            select.value = c;
            updateMap();
        };
        legend.appendChild(item);
    });

    // --- Logic ---
    function togglePrice(level, btn) {
        if (activePrices.includes(level)) {
            activePrices = activePrices.filter(p => p !== level);
            btn.classList.remove('active');
        } else {
            activePrices.push(level);
            btn.classList.add('active');
        }
        updateMap();
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function toggleHelp() {
        const modal = document.getElementById('helpModal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    }

    function onBoroughChange() {
        var b = document.getElementById('boroughSelect').value;
        if (b !== "All" && boroughCenters[b]) {
            // Fly to borough centroid
            // Zoom level 13 is usually good for a borough view
            map.flyTo(boroughCenters[b], 13, {
                animate: true,
                duration: 1.5
            });
        } else if (b === "All") {
            // Reset to London view
            map.flyTo([51.5074, -0.1278], 11, {
                animate: true,
                duration: 1.5
            });
        }
        updateMap();
    }

    // Helper to get color for hype score
    function getHypeColor(score) {
        // Gradient from Yellow (0.0) to Green (1.0+)
        // Simple thresholding for now
        if (score >= 1.0) return "#006400"; // Dark Green
        if (score >= 0.5) return "#2a9d8f"; // Teal
        if (score >= 0.2) return "#e9c46a"; // Yellow-Orange
        return "#f4a261"; // Orange
    }

    function updateMap() {
        var selectedCuisine = document.getElementById('cuisineSelect').value;
        var selectedBorough = document.getElementById('boroughSelect').value;
        var minRating = parseFloat(document.getElementById('ratingRange').value);
        var minReviews = parseInt(document.getElementById('reviewRange').value);
        var searchText = document.getElementById('searchInput').value.toLowerCase();
        var showUnderrated = document.getElementById('underratedToggle').checked;
        var onlyIndependents = document.getElementById('independentToggle').checked;
        
        document.getElementById('ratingVal').innerText = minRating.toFixed(1);
        document.getElementById('reviewVal').innerText = minReviews;
        
        markersLayer.clearLayers();
        
        var count = 0;
        
        restaurants.forEach(r => {
            // Filters
            if (onlyIndependents) {
                // is_chain: 1 => chain, 0 => independent
                if (r.is_chain === 1) return;
            }

            if (showUnderrated) {
                // If toggle is ON, only show positive hype residuals
                if (r.hype_residual <= 0.1) return;
            }

            if (selectedCuisine !== "All" && r.cuisine_group !== selectedCuisine) return;
            if (selectedBorough !== "All" && r.borough !== selectedBorough) return;
            if (r.rating < minRating) return;
            if (r.reviews < minReviews) return;
            if (!activePrices.includes(r.price)) return;
            if (searchText && !r.name.toLowerCase().includes(searchText)) return;
            
            count++;
            
            var color;
            var radius = 6;
            
            if (showUnderrated) {
                color = getHypeColor(r.hype_residual);
                // Make highly underrated spots slightly larger
                if (r.hype_residual > 0.5) radius = 8;
            } else {
                color = cuisineColors[r.cuisine_group] || "#333";
            }
            
            var marker = L.circleMarker([r.lat, r.lon], {
                radius: radius,
                fillColor: color,
                color: "white",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.85
            });
            
            var priceStr = r.price > 0 ? '¬£'.repeat(r.price) : '?';
            var hypeBadge = "";
            if (r.hype_residual > 0.2) {
                hypeBadge = `<span class="underrated-badge" title="Actual rating is ${r.hype_residual} higher than expected">Underrated +${r.hype_residual}</span>`;
            }
            
            var popupContent = `
                <div class="popup-header" style="${showUnderrated ? 'background:'+color : ''}">
                    <h3 class="popup-title">${r.name}</h3>
                </div>
                <div class="popup-body">
                    <div class="popup-meta">
                        <span>${r.cuisine}</span>
                        <span>${priceStr}</span>
                    </div>
                    <div class="popup-rating">
                        <span class="star-icon">‚òÖ</span> ${r.rating} 
                        <span style="color:#888; font-weight:400; font-size:12px; margin-left:4px;">(${r.reviews} reviews)</span>
                        ${hypeBadge}
                    </div>
                    <p style="margin: 8px 0 0 0; color: #555;">${r.vicinity}</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lon}" target="_blank" class="popup-link">
                        Get Directions
                    </a>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markersLayer.addLayer(marker);
        });
        
        document.getElementById('stats').innerHTML = `<strong>${count.toLocaleString()}</strong> restaurants visible`;
    }
    
    // Initial Load
    updateMap();
    
    // Show help modal on startup
    setTimeout(toggleHelp, 500); // Small delay for smooth entrance

</script>

</body>
</html>
